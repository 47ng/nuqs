import { expect, test, type Page } from '@playwright/test'
import { navigateTo } from 'e2e-shared/playwright/navigate.ts'

async function waitForHydration(page: Page) {
  await page.locator('#hydration-marker').waitFor({ state: 'hidden' })
  await page.waitForTimeout(50)
}

function clickNext(page: Page) {
  return page
    .getByRole('link', { name: 'Next', exact: true, includeHidden: false })
    .filter({ visible: true, hasText: 'Next' })
    .first()
    .click()
}

function withId(page: Page, id: string) {
  return page.locator(`#${id}`).filter({ visible: true })
}

test.describe('routing-tour', () => {
  test('server -> a', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/server')

    await page.locator('a').filter({ hasText: 'a (server, prefetch)' }).click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=start.server')
    await expect(withId(page, 'from')).toHaveText('start.server')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=1')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=2')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=3')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=4')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('server -> b', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/server')

    await page
      .locator('a')
      .filter({ hasText: 'b (server, no prefetch)' })
      .click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=start.server')
    await expect(withId(page, 'from')).toHaveText('start.server')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=1')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=2')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=3')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=4')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('server -> c', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/server')

    await page.locator('a').filter({ hasText: 'c (client, prefetch)' }).click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=start.server')
    await expect(withId(page, 'from')).toHaveText('start.server')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=1')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=2')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=3')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=4')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('server -> d', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/server')

    await page
      .locator('a')
      .filter({ hasText: 'd (client, no prefetch)' })
      .click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=start.server')
    await expect(withId(page, 'from')).toHaveText('start.server')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=1')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=2')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=3')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=4')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('client -> a', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/client')

    await page.locator('a').filter({ hasText: 'a (server, prefetch)' }).click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=start.client')
    await expect(withId(page, 'from')).toHaveText('start.client')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=1')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=2')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=3')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=4')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('client -> b', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/client')

    await page
      .locator('a')
      .filter({ hasText: 'b (server, no prefetch)' })
      .click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=start.client')
    await expect(withId(page, 'from')).toHaveText('start.client')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=1')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=2')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=3')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=4')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('client -> c', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/client')

    await page.locator('a').filter({ hasText: 'c (client, prefetch)' }).click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=start.client')
    await expect(withId(page, 'from')).toHaveText('start.client')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=1')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=2')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=3')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=4')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('4')
  })

  test('client -> d', async ({ page }) => {
    await navigateTo(page, '/app/routing-tour/start/client')

    await page
      .locator('a')
      .filter({ hasText: 'd (client, no prefetch)' })
      .click()
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=start.client')
    await expect(withId(page, 'from')).toHaveText('start.client')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('0')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/a/)
    await expect(page).toHaveURL(url => url.search === '?from=d&counter=1')
    await expect(withId(page, 'from')).toHaveText('d')
    await expect(withId(page, 'this')).toHaveText('a')
    await expect(withId(page, 'next')).toHaveText('b')
    await expect(withId(page, 'counter')).toHaveText('1')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/b/)
    await expect(page).toHaveURL(url => url.search === '?from=a&counter=2')
    await expect(withId(page, 'from')).toHaveText('a')
    await expect(withId(page, 'this')).toHaveText('b')
    await expect(withId(page, 'next')).toHaveText('c')
    await expect(withId(page, 'counter')).toHaveText('2')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/c/)
    await expect(page).toHaveURL(url => url.search === '?from=b&counter=3')
    await expect(withId(page, 'from')).toHaveText('b')
    await expect(withId(page, 'this')).toHaveText('c')
    await expect(withId(page, 'next')).toHaveText('d')
    await expect(withId(page, 'counter')).toHaveText('3')

    await clickNext(page)
    await waitForHydration(page)
    await expect(page).toHaveURL(/\/app\/routing-tour\/d/)
    await expect(page).toHaveURL(url => url.search === '?from=c&counter=4')
    await expect(withId(page, 'from')).toHaveText('c')
    await expect(withId(page, 'this')).toHaveText('d')
    await expect(withId(page, 'next')).toHaveText('a')
    await expect(withId(page, 'counter')).toHaveText('4')
  })
})
