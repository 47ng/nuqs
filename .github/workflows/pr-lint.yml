name: Lint PR Title

on:
  pull_request:
    types:
      - opened
      - edited

jobs:
  lint-pr-title:
    name: Lint PR Title
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version-file: .node-version
          cache: pnpm
      - name: Install dependencies
        run: pnpm add -D @commitlint/load @commitlint/lint
      - name: Lint PR title
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: |
          node -e "
            import loadConfig from '@commitlint/load';
            import lint from '@commitlint/lint';
            import pkgJson from './package.json' with { type: 'json' };
            const config = await loadConfig(pkgJson.commitlint);
            const result = await lint(process.env.TITLE, config.rules, config.parserPreset ? { parserOpts: config.parserPreset.parserOpts } : {});
            process.env.GITHUB_STEP_SUMMARY += \`## Linting Result\n- Valid: \${result.valid}\n\`;
            if (result.valid === false) {
              for (const { message } of result.errors) {
                process.env.GITHUB_STEP_SUMMARY += \`- Error: \${message}\n\`;
                console.error(message);
              }
              process.exit(1);
            }
          "
